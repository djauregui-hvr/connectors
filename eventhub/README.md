# hvreventhubagent.py
## Description
This python script can be used to send CDC changes to an Azure EventHub.  The EventHub connector sends the contents of files, 
generated by integrate, to an EventHub using a python EventHub package. The target data can be in any format supported by 
HVR via the fileFormat action.

## Requirements
- Integrate running on a Windows or Linux machine
- Python azure-eventhub package downloaded and installed.
- A Shared Access Policy name and key for accessing the EventHub

## Environment variables

| Environment variable         | Mandatory | Description |
| --------------------         | --------- | ----------- |
| HVR_EVENTHUB_NAMESPACE       |    Yes    | Azure Namespace where the EventHub resides |
| HVR_EVENTHUB_NAME            | (name req)| Name of the Event Hub - see "EventHub Name" |
| HVR_EVENTHUB_NAME_FORMAT     | (name req)| Syntax to derive the name of the EventHub - see "EventHub Name" |
| HVR_EVENTHUB_USER            |    Yes    | Shared Access Policy name |
| HVR_EVENTHUB_KEY             |    Yes    | Shared Access Policy key |
| HVR_EVENTHUB_FILE_EXPR       |     No    | The /RenameExpression from the Integrate action - see "EventHub Name" |
| HVR_EVENTHUB_PARTITION       |     No    | The partition id or "TXNID" - see "Partition by Transaction ID" |
| HVR_EVENTHUB_IGNORE_COLS     |     No    | Ignore updates to these columns - see "Collapse Updates" |
| HVR_EVENTHUB_JOURNAL_BATCHES |     No    | Log every batch sent to the EventHub - see "Message Logging" |
| HVR_INVALID_FILE_LOC         |     No    | If set and the connector fails opening a file, move the file here |
| HVR_EVENTHUB_TRACE           |     No    | If set, indicates the tracing level: <br>  0: No Tracing<br>  1: Trace messages<br>  2: Trace message contents |

## UserArgument options
The following options may be set in the /UserArguments of the AgentPlugin action for hvreventhubagent.py

| Option       | Description |
| ------       | ----------- |
| -b<prefix>   | The prefix for the before image - see "Collapse Updates" |
| -c<a/c><d>   | Enable the collapse option - see "Collapse Updates" |
| -d<colname>  | Mark end-of-transaciton - see "Transaction End Marker" |
| -f<fail/ok>  | Fail or continue if integrate file does not exist - see "Recovery" |
| -m<maxlen>   | Maximum message length. An EventHub message has an upper limit. If the integrate file exceeds <br>this length, it will be skipped. Default is 1046500 bytes. |
| -o<opcol>    | Name of the /Extra column with /IntegrateExpression={hvr_op} - see "Collapse Updates" |
| -t<#>        | Trace level (see HVR_EVENTHUB_TRACE) |

## EventHub Connection
The python event hub library uses https to connect to the EventHub service. To connect the agent needs an address, an access policy name, and an access 
policy key. The address includes in it the names of the EventHub namespace and the EventHub. The agent generates the address using the values provided i
either by the environment variables or the command line options.

For instance, if the EventHub namespace is "hvrevents", and the name of the EventHub is "testtable", the agent would generate the following address:
   amqps://hvrevents.servicebus.windows.net/testtable

If, for any reason, it is necessary to override this logic and provide the address for the agent to use, set the address using HVR_EVENTHUB_ADDRESS.

## EventHub Name
The name can be specified as a fixed value, or the name can be derived by the EventHub agent from values in the file name.  If the name is a fixed value, set HVR_EVENTHUB_NAME to that name.  Otherwise, set HVR_EVENTHUB_FILE_EXPR to the Integrate /RenameExpression for this channel.  Then set HVR_EVENTHUB_NAME_FORMAT to a string from which the connector can derive the EventHub name.   Note that the valid HVR substitution values for HVR_EVENTHUB_NAME_FORMAT are any of those used in the Integrate /RenameExpression and {hvr_chn_name} and {hvr_integ_loc}.

For instance, it may be desirable to have an EventHub for each source table. For this to happen, the Integrate action's /RenameExpression must include "{hvr_tbl_name}".  Below is an example configuration.

    Integrate /RenameExpression="{hvr_tbl_name}/{hvr_integ_tstamp}.csv"
    Environment /Name=HVR_EVENTHUB_FILE_EXPR /Value="{hvr_tbl_name}/{hvr_integ_tstamp}.csv"
    Environment /Name=HVR_EVENTHUB_NAME_FORMAT /Value=sypd_{hvr_tbl_name}

## Partition Id
If the partition id is not set, and the EventHub is defined with more than one partition, the EventHub service will assign the message 
to a partition using a "spread the work" type algorithm. If consistency between messages is important, then a partition id should be defined.

The partition Id can be set to a number between 0 and the number of partitions for the EventHub, or 'TXNID' (see Partition by Transaction Id)

## Message Length
The EventHub documentation states that a message cannot be greater than 1MB. In fact the maximum message size seems to be smaller 
than this value as seen by the error message generated by the EventHub service:

    ErrorCodes.LinkMessageSizeExceeded: The received message (delivery-id:1, size:1046535 bytes) exceeds the limit (1046528 bytes) currently allowed on the link.

Currently, the default behavior of the EventHub agent is to log a message and skip processing of any integrate file whose size is 
greater than 1046500 bytes. To ensure that the agent fails if a message is too large, the maximum supported byte size can be increased 
using the "-m" command line option. Set MaxFileSize on the integrate action to ensure that integrate files are not created that are 
greater than the maximum supported.

## Partition by Transaction ID
If HVR_EVENTHUB_PARTITION is set to ‘TXNID’, the agent plugin will use the transaction id to assign the partition id. This functionality 
is only valid for an Oracle source. It requires that the {hvr_tx_seq} variable be a part of the Integrate /RenameExpression. The script 
will not auto-assign the partition id for refresh as {hvr_txn_seq} is not populated by refresh.  When enabled, every file written by 
integrate will contain the changes for one transaction and the {hvr_tx_seq} for that transaction will be in the file name. Note that HVR
writes a separate file for every table in the transaction so {hvr_tbl_name} should also be in the /RenameExpression. For example:

    /RenameExpression="tranxtbl/{hvr_integ_tstamp}_{hvr_tbl_name}_{hvr_tx_seq}.csv"

## Collapse Updates
If an Extra column with the /TimeKey option is defined, for every update HVR will generate a before image row and an after image row.
The script can be configured to collapse these two rows into one row.  The requirements for this logic are:
- An /Extra column is defined with /IntegrateExpression={hvr_op} (this may be the /TimeKey column)
- The FileFormat is /Json /JsonMode=ROW_ARRAY

This is configured in the UserArguments option of the AgentPlugin action as follows:

    -ca        : Merge all columns of the before and after image.  Same as FileFormat /BeforeUpdateColumns
    -cc        : Append to the after image row the preimage of the columns that changed.  Same as FileFormat /BeforeUpdateColumnsWhenChanged
    -o<opcol>  : The name of the /Extra column defined with /IntegrateExpression={hvr_op}
    -b<prefix> : Prefix for the before image values.  Default is 'Old&'

If there are other /Extra columns defined that have a different value for each row written to the Json file (for instance, {hvr_tx_countdown}),
an Environment action can be added to specify those column which, if their values change, should not be added to the update row. For example:

    AgentPlugin /Command=hvreventhubagent.py /UserArgument="-cc -o sys_op"
    ColumnProperties /Name=sys_captstamp /Extra /IntegrateExpression={hvr_cap_tstamp} /Datatype=timestamp /Precision=10
    ColumnProperties /Name=sys_op /Extra /IntegrateExpression={hvr_op} /TimeKey /Datatype=integer
    Environment /Name=HVR_EVENTHUB_IGNORE_COLS /Value=sys_captstamp,sys_op

This logic can be further modified to discard both the before and after image of any update where there is no difference.  This is 
configured as follows:

    -cad       : Merge all columns of the before and after image if there are differences, discard if no differences
    -ccd       : Append to the after image row the preimage of the columns that changed if there are differences, discard if no differences

## Transaction End Marker
If the 'Partition Id by Transaction ID' logic is enabled, all the changes for a transaction will be routed to the same partition id in the EventHub.
This logic can be further enhanced by marking the last row change in a transaction as the end of the transaction.  The script does this 
by setting the value of a specified /Extra column to '1' for the last row.  The requirements for this functionality are:
- An /Extra column is defined with /Datatype=integer
- The FileFormat is /Json /JsonMode=ROW_ARRAY

This is configured in the UserArguments option of the AgentPlugin action as follows:

    -d<colnam> : The name of the /Extra column to be used as an end-of-transaction marker

For example:

    AgentPlugin /Command=hvreventhubagent.py /UserArgument="-d sys_end_transaction"
    ColumnProperties /Name=sys_end_transaction /Extra /Datatype=integer	

## Message Logging
The script can be configured to log every message sent to the EventHub.  To enable this feature, set an Environment action as follows:

    /Name=HVR_EVENTHUB_JOURNAL_BATCHES /Value=<location on integrate machine for the journal files>

The files are named as follows:

    channel_loc_date_time_partitionid_seq

## Recovery
By default the connector removes each file as soon as it is uploaded.  At the same time it writes the filename out to a temp cache.  If the connector is interrupted (by suspending capture, for instance), the connector reads in the temp cache and skips the processing of any file named in the cache. 
